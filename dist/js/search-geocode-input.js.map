{"version":3,"sources":["search-geocode-input.js"],"names":["$","Drupal","GOOGLE_API_KEY","GOOGLE_API_KEY_TEMP","GOOGLE_GEOCODER_BASEURL","GOOGLE_FILTER_BOUNDING_BOX","GOOGLE_FILTER_COMPONENTS","$form","behaviors","uwmGeocodeInputInit","attach","context","settings","document","ready","$addressContainer","find","$addressInput","val","length","addClass","on","removeClass","getGeocodeResponse","e","preventDefault","getNavigatorUserLocation","queryString","clearUserLocation","apikey","window","location","host","indexOf","ajax","url","dataType","type","data","address","bounds","components","key","success","response","status","parseGeocodeResponse","handleGeocodeError","error","xhr","handleGeocodeSuccess","navigator","geolocation","getCurrentPosition","position","coords","latitude","longitude","ShowLocation","map","apiResponse","isValid","i","results","item","geometry","formatted_address","lat","lng","setUserMessage","message","text","jQuery"],"mappings":"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","file":"search-geocode-input.js","sourcesContent":["/**\n *\n * Script to take the address a user has typed in our location search form,\n * and to query Google's Geocode API for the best possible location match. We\n * then use the latitude/ longitude for a Drupal locations search.\n *\n */\n(function ($, Drupal) {\n\n  /**\n   * Provide API key for requests.\n   * @see https://console.cloud.google.com/home/dashboard?project=uw-medicine\n   * @type {string}\n   */\n  const GOOGLE_API_KEY = 'AIzaSyDyy0tzNE5Pvxx-hWO_SIgb-guPGWOo2vo';\n\n  /**\n   * Provide API key without hostname restrictions.\n   * @see https://console.cloud.google.com/home/dashboard?project=uw-medicine\n   * @type {string}\n   */\n  const GOOGLE_API_KEY_TEMP = 'AIzaSyB6ziIhPThPpqSPKLeJKs1wnblBXQbbxe4';\n  /**\n   * Provide base url for our geocode, Google.\n   * @see https://developers.google.com/maps/documentation/geocoding/start\n   * @type {string}\n   */\n  const GOOGLE_GEOCODER_BASEURL = 'https://maps.googleapis.com/maps/api/geocode/json?';\n\n  /**\n   * Preferred bounding box for results.\n   * @see https://developers.google.com/maps/documentation/geocoding/intro#Viewports\n   * @type {string}\n   */\n  const GOOGLE_FILTER_BOUNDING_BOX = '46.709241,-123.422571|48.254976,-119.381319';\n\n  /**\n   * Limit results to these criteria.\n   * @see https://developers.google.com/maps/documentation/geocoding/intro#ComponentFiltering\n   * @type {string}\n   */\n    // const GOOGLE_FILTER_COMPONENTS = 'administrative_area_level_1:WA|country:US';\n  const GOOGLE_FILTER_COMPONENTS = '';\n\n  /**\n   *\n   * @type {*|HTMLElement}\n   */\n  let $form = $();\n\n  /**\n   * Attach behaviors once Drupal readies page.\n   * @type {{attach(*, *): void}}\n   */\n  Drupal.behaviors.uwmGeocodeInputInit = {\n\n    attach(context, settings) {\n\n      $(document).ready(() => {\n\n        $form = $('section.content-topper form');\n        const $addressContainer = $form.find('.location-address-keywords');\n        const $addressInput = $addressContainer.find('input[name=l]');\n\n\n        // Set state on load:\n        if ($form.find('input[name=uml]').val().length > 0) {\n          $(\"body\").addClass(\"search-with-geocoding\");\n        }\n\n        // Handle address focus:\n        $addressInput.on('focus', e => {\n          $addressContainer.addClass('active');\n        });\n\n        // Handle address blur:\n        $addressInput.on('blur', e => {\n          $addressContainer.removeClass('active');\n          getGeocodeResponse();\n\n        });\n\n        $addressContainer.find('.dropdown a').on('click', e => {\n          e.preventDefault();\n          getNavigatorUserLocation();\n\n        });\n\n        // $form.find('.location-address-keywords').on('show.bs.dropdown', () => {\n        // });\n\n\n\n      });\n\n    }\n\n  };\n\n  /**\n   *\n   * @param queryString\n   */\n  const getGeocodeResponse = function (queryString) {\n\n    if (!queryString) {\n      clearUserLocation();\n      return;\n    }\n\n    let apikey = GOOGLE_API_KEY;\n    if (window.location.host.indexOf('local') > 0) {\n      apikey = GOOGLE_API_KEY_TEMP;\n    }\n\n    $.ajax({\n      url: GOOGLE_GEOCODER_BASEURL,\n      dataType: \"json\",\n      type: \"GET\",\n      data: {\n        address: $form.find('input[name=l]').val(),\n        bounds: GOOGLE_FILTER_BOUNDING_BOX,\n        components: GOOGLE_FILTER_COMPONENTS,\n        key: apikey\n      },\n      success(response) {\n        if (response.status === \"OK\") {\n          parseGeocodeResponse(response);\n        }\n        else {\n          handleGeocodeError();\n        }\n      },\n      error(xhr) {\n        handleGeocodeError();\n      }\n    });\n\n\n  };\n\n  const getNavigatorUserLocation = function () {\n\n    handleGeocodeSuccess('Current location', 0, 0);\n    if (!navigator.geolocation) {\n      handleGeocodeError();\n    }\n    else {\n      navigator.geolocation.getCurrentPosition((position) => {\n\n        handleGeocodeSuccess('Current location', position.coords.latitude, position.coords.longitude);\n        this.ShowLocation(position, this.map);\n\n      }, () => {\n        handleGeocodeError();\n      });\n    }\n\n  };\n\n  /**\n   *\n   * @param apiResponse\n   * @return {*}\n   */\n  const parseGeocodeResponse = function (apiResponse) {\n\n    const isValid = true;\n\n    for (let i = 0; i < apiResponse.results.length; i++) {\n\n      const item = apiResponse.results[i];\n\n      // Do our match validation...\n      // The geocode API assumes an address was provided. Since we may have any\n      // search string, and parsing Google address component is brittle,\n      // let's just validate the user input is in the formatted result.\n      // const arr = USER_SEARCH_STRING.toLowerCase().split(' ');\n      // arr.forEach((pt) => {\n      //   if (item.formatted_address.toLowerCase().replace(' ', '').indexOf(pt) >= 0) {\n      //     isValid = true;\n      //   }\n      // });\n\n      // Save preferred result...\n      if (isValid && item && item.geometry && item.geometry.location) {\n\n        handleGeocodeSuccess(item.formatted_address, item.geometry.location.lat, item.geometry.location.lng);\n\n      }\n      else {\n        handleGeocodeError();\n      }\n\n    }\n\n  };\n\n  /**\n   *\n   * @param apiResponse\n   * @return {*}\n   */\n  const handleGeocodeSuccess = function (address, lat, lng) {\n\n    clearUserLocation();\n\n    $(\"body\").addClass(\"search-with-geocoding\");\n\n    $('input[name=l]').val(address);\n    if (lat && lng) {\n      $('input[name=uml]').val(`${  lat  },${  lng  }`);\n    }\n  };\n\n\n  /**\n   *\n   * @param apiResponse\n   * @return {*}\n   */\n  const handleGeocodeError = function () {\n\n    clearUserLocation();\n\n    $(\"body\").removeClass(\"search-with-geocoding\");\n    $('input[name=uml]').val('');\n\n    setUserMessage('No matches found. Try again.');\n  };\n\n  /**\n   *\n   * @param message\n   */\n  const clearUserLocation = function () {\n\n    $(\"body\").removeClass(\"search-with-geocoding\");\n    $('input[name=uml]').val('');\n    setUserMessage('');\n\n  };\n\n  /**\n   *\n   * @param message\n   */\n  const setUserMessage = function (message) {\n\n    const $form = $('.content-topper .status-message');\n    $form.text(message);\n\n  };\n\n})\n(jQuery, Drupal);\n"]}